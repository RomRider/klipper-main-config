[gcode_macro SET_FAN_FACTOR]
description: Apply a factor to the fan speed
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set old_speed_factor = svv.fan_factor|default(100, true) | int %}
    {% set speed_factor = params.FACTOR|default(svv.fan_factor|default(100, true), true) | int %}

    {% if speed_factor >= 1 and speed_factor <= 100 %}
    SAVE_VARIABLE VARIABLE=fan_factor VALUE={speed_factor}
    {% else %}
    action_raise_error("F should be between 1 and 100")
    {% endif %}

    {% if (params.APPLY | default(false, true)) | lower == 'true' %}
    M106.1 S{((printer.fan.speed * 255 / (old_speed_factor / 100)) * (speed_factor / 100))}
    {% endif %}

[gcode_macro M106]
rename_existing: M106.1
gcode:
    {% set fan_factor = printer.save_variables.variables.fan_factor | int %}
    {% if fan_factor is defined and fan_factor >= 1 and fan_factor <= 100 %}
    M106.1 S{(params.S | int * (fan_factor / 100))}
    {% else %}
    M106.1 S{params.S}
    {% endif %}

[menu __main __control __fanspeedfactor]
type: input
index: 7
enable: {'fan' in printer}
name: Fan ratio: {'%3d' % (menu.input)}%
input: {printer.save_variables.variables.fan_factor | default(100, true)}
input_min: 1
input_max: 100
input_step: 1
gcode:
    SET_FAN_FACTOR FACTOR={menu.input} APPLY=true