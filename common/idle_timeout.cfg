[idle_timeout]
gcode:
  {% if printer.webhooks.state|lower == 'ready' %}
    {% if printer.pause_resume.is_paused|lower == 'false' %}
      M84
      TURN_OFF_HEATERS
      {% set svv = printer.save_variables.variables %}
      {% if svv.auto_off | default(1) %}
        UPDATE_DELAYED_GCODE ID=delayed_printer_off DURATION={ 600 if printer.extruder.temperature | float > 50 else 1 }
      {% endif %}
    {% endif %}
  {% endif %}

[gcode_macro POWER_OFF_PRINTER]
gcode:
  {% if 'neopixel leds' in printer.configfile.settings %}
    LED_OFF
  {% endif %}
  {action_call_remote_method("set_device_power",
                             device=printer["gcode_macro VARIABLES"].moonraker_powerplug_name,
                             state="off")}

[delayed_gcode delayed_printer_off]
initial_duration: 0.
gcode:
  {% set svv = printer.save_variables.variables %}
  {% if svv.auto_off | default(1) %}
    {% if printer.idle_timeout.state == "Idle" %}
      POWER_OFF_PRINTER
    {% endif %}
  {% endif %}

[menu __main __power __auto_off]
type: input
enable: {"idle_timeout" in printer.configfile.settings}
name: Auto-Off: {"On" if menu.input else "Off"}
input: {printer.save_variables.variables.auto_off|default(1)}
input_min: 0
input_max: 1
input_step: 1
gcode:
  {% set svv = printer.save_variables.variables %}
  SAVE_VARIABLE VARIABLE=auto_off VALUE={menu.input|default(svv.auto_off|default(1)) | int}