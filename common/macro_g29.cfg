[gcode_macro G29]
gcode:
  {% set ps = printer.configfile.settings %}
  G1 Z10 F600
  {% if 'z_tilt' in ps %}
    {% if not printer.z_tilt.applied %}
      M117 Z-Tilt...
      Z_TILT_ADJUST ;Adjust bed tilt
    {% endif %}
    G28 Z ;Home again as Z will have changed after tilt adjustment
  {% endif %}
  {% if 'bltouch' in ps or 'probe' in ps %}
    {% if 'AREA_START' in params and 'AREA_END' in params %}
      M117 Area Bed Mesh...
      BED_MESH_CALIBRATE AREA_START={params.AREA_START | replace("=", "")} AREA_END={params.AREA_END | replace("=", "")}
    {% else %}
      M117 Bed Mesh...
      BED_MESH_CALIBRATE
    {% endif %}
  {% endif %}
  M117
