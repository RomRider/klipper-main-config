[menu __main __setup __calibrate_z]
type: list
enable: { 'probe' in printer.configfile.settings or 'bltouch' in printer.configfile.settings }
name: Calibrate Z

[menu __main __setup __calibrate_z __calib]
type: command
name: Start
gcode:
    {% if printer.toolhead.homed_axes != "xyz" %}
        G28
    {% endif %}
    _CENTER_PROBE
    PROBE_CALIBRATE

[menu __main __setup __calibrate_z __test_z]
type: input
name: Z: {"N/A" if menu.input == -2 else "-" if menu.input == 0 else "--" if menu.input == -1 else "+" if menu.input == 1 else "++" if menu.input == 2}
input: 0
input_step: 1
input_min: -2
input_max: 2
gcode:
    {% if menu.input != -2 %}
    TESTZ Z={"-" if menu.input == 0 else "--" if menu.input == -1 else "+" if menu.input == 1 else "++" if menu.input == 2}
    {% endif %}

[menu __main __setup __calibrate_z __test_z_abs]
type: input
name: Z Abs.: {menu.input}
input: 0
input_step: 0.01
input_min: -5
input_max: 5
gcode:
    TESTZ Z={menu.input}

[menu __main __setup __calibrate_z __accept]
type: command
name: Accept
gcode:
    ACCEPT

[menu __main __setup __calibrate_z __abort]
type: command
name: Abort
gcode:
    ABORT

[gcode_macro _CENTER_PROBE]
gcode:
    SAVE_GCODE_STATE NAME=center_probe
    {% if 'safe_z_home' in printer.configfile.settings %}
        {% set speed = printer.configfile.settings.safe_z_home.speed | int * 60 %}
    {% else %}
        {% set speed = 100 * 60 %}
    {% endif %}
    G90
    {% if 'probe' in printer.configfile.settings %}
        {% set x = printer.toolhead.axis_maximum.x / 2 - printer.configfile.config.probe.x_offset | float %}
        {% set y = printer.toolhead.axis_maximum.y / 2 - printer.configfile.config.probe.y_offset | float %}
        G1 X{x} Y{y} Z10 F{speed}
    {% elif 'bltouch' in printer.configfile.settings %}
        {% set x = printer.toolhead.axis_maximum.x / 2 - printer.configfile.config.bltouch.x_offset | float %}
        {% set y = printer.toolhead.axis_maximum.y / 2 - printer.configfile.config.bltouch.y_offset | float %}
        G1 X{x} Y{y} Z10 F{speed}
    {% endif %}
    RESTORE_GCODE_STATE NAME=center_probe

