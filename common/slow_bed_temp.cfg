[gcode_macro M190]
rename_existing: M190.1
gcode:
  {% set target_temp = params.S | int %}
  {% set bed_soak_time_per_degree_before_20 = printer["gcode_macro VARIABLES"].bed_soak_time_per_degree_before_20 | default(0) %}
  {% set bed_soak_time_per_degree_after_20 = printer["gcode_macro VARIABLES"].bed_soak_time_per_degree_after_20 | default(0) %}
  {% set svv = printer.save_variables.variables %}
  {% if printer["gcode_macro VARIABLES"].slow_bed | default(0) == 1 and printer.heater_bed.temperature < target_temp %}
    { action_respond_info("Slow Bed: Wait for min. temperature %s" % target_temp) }
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={ target_temp }
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={ target_temp }
  {% else %}
    M190.1 S{ target_temp }
  {% endif %}

  {% if target_temp > 0 and bed_soak_time_per_degree_before_20 + bed_soak_time_per_degree_after_20 > 0 %}
    {% set bed_temp_current = printer.heater_bed.temperature %}
    {% set bed_temp_difference = target_temp - bed_temp_current %}
    {% set soak_delay = 0 %}
    {% if bed_temp_difference >= 20 %}
      {% set soak_delay = 20 * bed_soak_time_per_degree_before_20 + (bed_temp_difference - 20) * bed_soak_time_per_degree_after_20 %}
    {% elif bed_temp_difference > 0 %}
      {% set soak_delay = bed_temp_difference * bed_soak_time_per_degree_after_20 %}
    {% endif %}
    {% set soak_delay = soak_delay | round | int %}
    {% if soak_delay > 0 %}
      { action_respond_info("Soaking Bed for %02dm%02ds" % ((soak_delay / 60) | abs | int, (soak_delay % 60) | int)) }
      {% for i in range(1, soak_delay + 1) | reverse %}
        {% if (i / 60) | abs | int > 0 %}
          M117 Bed Soak: { (i / 60) | abs | int }m{ '%02d' % (i % 60 | int) }s
        {% else %}
          M117 Bed Soak: { '%02d' % (i % 60 | int) }s
        {% endif %}
        G4 P1000
      {% endfor %}
    {% endif %}
    M117
  {% endif %}

[gcode_macro SET_BED_SOAK_TIME]
gcode:
  {% set minutes = params.MINUTES|default(2) | int %}
  SAVE_VARIABLE VARIABLE=bed_soak_time VALUE={minutes}
  {% if minutes > 0 %}
    M118 Bed Soak Time set to {minutes}min
  {% else %}
    M118 Bed Soak disabled
  {% endif %}

[menu __main __temp __bed_soak]
type: input
index: 3
enable: True
name: { "Bed Soak: %dmin" % menu.input if menu.input > 0 else "Bed Soak: Off" }
input: {printer.save_variables.variables.bed_soak_time|default(0, true) | int }
input_min: 0
input_max: 10
input_step: 1
gcode:
  SET_BED_SOAK_TIME MINUTES={ ('%d' % menu.input) | int }